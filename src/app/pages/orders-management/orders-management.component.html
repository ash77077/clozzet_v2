<div class="orders-management-container">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb">
    <a routerLink="/dashboard" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">></span>
    <span class="breadcrumb-current">Orders Management</span>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="page-title">Orders Management</h1>
        <p class="page-description">Manage all orders in the system</p>
      </div>
      <div class="header-right">
        <p-button 
          label="Export Orders" 
          icon="pi pi-download" 
          severity="secondary"
          *ngIf="isAdminOrManager()">
        </p-button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner"></div>
    <p>Loading orders...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !isLoading">
    <div class="error-message">
      <h3>Error Loading Orders</h3>
      <p>{{ error }}</p>
      <p-button label="Retry" (onClick)="loadOrders()" severity="secondary"></p-button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="orders-content" *ngIf="!isLoading && !error">
    
    <!-- Filters and Search -->
    <section class="filters-section">
      <div class="filters-container">
        <!-- Search -->
        <div class="search-group">
          <label for="search">Search Orders</label>
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input 
              pInputText 
              id="search"
              type="text" 
              [(ngModel)]="searchTerm" 
              (input)="onSearchChange()"
              placeholder="Search by order number, customer, or company..."
              class="w-full">
          </span>
        </div>

        <!-- Status Filter -->
        <div class="filter-group">
          <label for="status-filter">Status</label>
          <p-select 
            [options]="availableStatuses" 
            [(ngModel)]="selectedStatus"
            (onChange)="onStatusChange()"
            optionLabel="label" 
            optionValue="value"
            placeholder="Select Status"
            id="status-filter"
            class="w-full">
          </p-select>
        </div>
      </div>
    </section>

    <!-- Orders Table -->
    <section class="table-section">
      <p-table 
        [value]="filteredOrders" 
        [loading]="isLoading"
        [paginator]="true" 
        [rows]="itemsPerPage"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        responsiveLayout="scroll"
        styleClass="p-datatable-gridlines p-datatable-striped"
        [scrollable]="true">
        
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="orderNumber" style="min-width: 150px">
              <div class="flex align-items-center">
                Order Number
                <p-sortIcon field="orderNumber"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="clientName" style="min-width: 200px">
              <div class="flex align-items-center">
                Client Name
                <p-sortIcon field="clientName"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="salesPerson" style="min-width: 150px">
              <div class="flex align-items-center">
                Sales Person
                <p-sortIcon field="salesPerson"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="quantity" style="min-width: 100px">
              <div class="flex align-items-center">
                Quantity
                <p-sortIcon field="quantity"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="priority" style="min-width: 120px">
              <div class="flex align-items-center">
                Priority
                <p-sortIcon field="priority"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="deadline" style="min-width: 150px">
              <div class="flex align-items-center">
                Deadline
                <p-sortIcon field="deadline"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="createdAt" style="min-width: 150px">
              <div class="flex align-items-center">
                Order Date
                <p-sortIcon field="createdAt"></p-sortIcon>
              </div>
            </th>
            <th style="min-width: 200px">Actions</th>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-order>
          <tr>
            <td>
              <strong>{{ order.orderNumber }}</strong>
            </td>
            <td>
              <div class="customer-info">
                <div class="customer-name">{{ order.clientName }}</div>
                <div class="cloth-type">{{ order.clothType }}</div>
              </div>
            </td>
            <td>{{ order.salesPerson }}</td>
            <td>
              <strong>{{ order.quantity }}</strong>
              <div class="textile-type">{{ order.textileType }}</div>
            </td>
            <td>
              <app-priority-badge [priority]="order.priority"></app-priority-badge>
            </td>
            <td>
              <span class="deadline-date" [class.urgent]="isDeadlineUrgent(order.deadline)">
                {{ formatDate(order.deadline) }}
              </span>
            </td>
            <td>{{ formatDate(order.createdAt!) }}</td>
            <td>
              <div class="flex gap-2">
                <p-button 
                  icon="pi pi-eye" 
                  (onClick)="viewOrderDetails(order)"
                  severity="info"
                  [text]="true"
                  [rounded]="true"
                  pTooltip="View Details">
                </p-button>
                <p-button 
                  icon="pi pi-pencil" 
                  (onClick)="editOrder(order)"
                  severity="warn"
                  [text]="true"
                  [rounded]="true"
                  *ngIf="isAdminOrManager()"
                  pTooltip="Edit Order">
                </p-button>
                <p-button 
                  icon="pi pi-trash" 
                  (onClick)="deleteOrder(order)"
                  severity="danger"
                  [text]="true"
                  [rounded]="true"
                  *ngIf="isAdminOrManager()"
                  pTooltip="Delete Order">
                </p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center p-4">
              <div class="empty-state">
                <i class="pi pi-shopping-cart" style="font-size: 3rem"></i>
                <h3>No Orders Found</h3>
                <p>No orders match your current filters. Try adjusting your search criteria.</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </section>
  </div>

  <!-- Order Details Dialog -->
  <p-dialog
    header="Order Details"
    [(visible)]="showOrderDetails"
    [modal]="true"
    [style]="{width: '90vw', maxWidth: '1200px', maxHeight: '90vh'}"
    [draggable]="false"
    [resizable]="false"
    [maximizable]="true"
    styleClass="order-details-modal"
    *ngIf="selectedOrder">

    <div class="order-details-dialog">
      <!-- Order Header -->
      <div class="order-header-card">
        <div class="order-summary">
          <div class="order-title-section">
            <h2 class="order-number">{{ selectedOrder.orderNumber }}</h2>
            <app-priority-badge [priority]="selectedOrder.priority"></app-priority-badge>
          </div>
          <div class="order-meta-grid">
            <div class="meta-item">
              <i class="pi pi-user"></i>
              <span class="meta-label">Client</span>
              <span class="meta-value">{{ selectedOrder.clientName }}</span>
            </div>
            <div class="meta-item">
              <i class="pi pi-calendar"></i>
              <span class="meta-label">Deadline</span>
              <span class="meta-value" [class.urgent]="isDeadlineUrgent(selectedOrder.deadline)">
                {{ formatDate(selectedOrder.deadline) }}
              </span>
            </div>
            <div class="meta-item">
              <i class="pi pi-box"></i>
              <span class="meta-label">Quantity</span>
              <span class="meta-value">{{ selectedOrder.quantity }} units</span>
            </div>
            <div class="meta-item">
              <i class="pi pi-tag"></i>
              <span class="meta-label">Type</span>
              <span class="meta-value">{{ selectedOrder.clothType }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Accordion -->
      <div class="content-accordion">
        <p-accordion value="0">
          <!-- Basic Information Panel -->
          <p-accordion-panel value="0">
            <p-accordion-header>
              <span class="accordion-header-content">
                <i class="pi pi-info-circle"></i>
                <span>Basic Information</span>
              </span>
            </p-accordion-header>
            <p-accordion-content>
              <div class="accordion-content">
                <div class="horizontal-layout">
                  <!-- Left Side: Data Columns -->
                  <div class="data-columns">
                    <!-- Client Information -->
                    <div class="data-column">
                      <h4 class="column-title">
                        <i class="pi pi-user"></i>
                        Client Information
                      </h4>
                      <div class="data-rows">
                        <div class="data-row">
                          <span class="label">Client Name:</span>
                          <span class="value">{{ selectedOrder.clientName }}</span>
                        </div>
                        <div class="data-row">
                          <span class="label">Sales Person:</span>
                          <span class="value">{{ selectedOrder.salesPerson }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Product Details -->
                    <div class="data-column">
                      <h4 class="column-title">
                        <i class="pi pi-box"></i>
                        Product Details
                      </h4>
                      <div class="data-rows">
                        <div class="data-row">
                          <span class="label">Cloth Type:</span>
                          <span class="value">{{ selectedOrder.clothType }}</span>
                        </div>
                        <div class="data-row">
                          <span class="label">Textile Type:</span>
                          <span class="value">{{ selectedOrder.textileType }}</span>
                        </div>
                        <div class="data-row">
                          <span class="label">Total Quantity:</span>
                          <span class="value">{{ selectedOrder.quantity }} units</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.fabricWeight">
                          <span class="label">Fabric Weight:</span>
                          <span class="value">{{ selectedOrder.fabricWeight }}g</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Right Side: Size Table -->
                  <div class="size-section" *ngIf="selectedOrder.sizeQuantities && getObjectKeys(selectedOrder.sizeQuantities).length > 0">
                    <h4 class="section-title">
                      <i class="pi pi-chart-bar"></i>
                      Size Breakdown
                    </h4>
                    <div class="size-table">
                      <table class="sizes-table">
                        <thead>
                          <tr>
                            <th *ngFor="let size of getObjectKeys(selectedOrder.sizeQuantities)">{{ size }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td *ngFor="let size of getObjectKeys(selectedOrder.sizeQuantities)">
                              {{ selectedOrder.sizeQuantities[size] }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </p-accordion-content>
          </p-accordion-panel>

          <!-- Design & Specifications Panel -->
          <p-accordion-panel value="1" *ngIf="selectedOrder.colors || selectedOrder.printingMethod || selectedOrder.logoPosition || hasGarmentSpecs()">
            <p-accordion-header>
              <span class="accordion-header-content">
                <i class="pi pi-palette"></i>
                <span>Design & Specifications</span>
              </span>
            </p-accordion-header>
            <p-accordion-content>
              <div class="accordion-content">
                <div class="horizontal-layout">
                  <!-- Left Side: Data Columns -->
                  <div class="data-columns">
                    <!-- Design Details -->
                    <div class="data-column" *ngIf="selectedOrder.colors || selectedOrder.printingMethod || selectedOrder.logoPosition">
                      <h4 class="column-title">
                        <i class="pi pi-palette"></i>
                        Design Details
                      </h4>
                      <div class="data-rows">
                        <div class="data-row" *ngIf="selectedOrder.colors && selectedOrder.colors.length > 0">
                          <span class="label">Colors:</span>
                          <div class="value">
                            <div class="colors-list">
                              <span *ngFor="let color of selectedOrder.colors" class="color-tag">{{ color }}</span>
                            </div>
                          </div>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.customColorDetails">
                          <span class="label">Custom Color Details:</span>
                          <span class="value">{{ selectedOrder.customColorDetails }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.pantoneColors">
                          <span class="label">Pantone Colors:</span>
                          <span class="value">{{ selectedOrder.pantoneColors }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.printingMethod">
                          <span class="label">Printing Method:</span>
                          <span class="value">{{ selectedOrder.printingMethod }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.logoPosition">
                          <span class="label">Logo Position:</span>
                          <span class="value">{{ selectedOrder.logoPosition }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.logoSize">
                          <span class="label">Logo Size:</span>
                          <span class="value">{{ selectedOrder.logoSize }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Garment Specifications -->
                    <div class="data-column" *ngIf="hasGarmentSpecs()">
                      <h4 class="column-title">
                        <i class="pi pi-cog"></i>
                        Garment Specifications
                      </h4>
                      <div class="data-rows">
                        <div class="data-row" *ngIf="selectedOrder.neckStyle">
                          <span class="label">Neck Style:</span>
                          <span class="value">{{ selectedOrder.neckStyle }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.sleeveType">
                          <span class="label">Sleeve Type:</span>
                          <span class="value">{{ selectedOrder.sleeveType }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.fit">
                          <span class="label">Fit:</span>
                          <span class="value">{{ selectedOrder.fit }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.hoodieStyle">
                          <span class="label">Hoodie Style:</span>
                          <span class="value">{{ selectedOrder.hoodieStyle }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.pocketType">
                          <span class="label">Pocket Type:</span>
                          <span class="value">{{ selectedOrder.pocketType }}</span>
                        </div>
                        <div class="data-row" *ngIf="selectedOrder.zipperType">
                          <span class="label">Zipper Type:</span>
                          <span class="value">{{ selectedOrder.zipperType }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </p-accordion-content>
          </p-accordion-panel>

          <!-- Files & Documents Panel -->
          <p-accordion-panel value="2" *ngIf="hasFiles()">
            <p-accordion-header>
              <span class="accordion-header-content">
                <i class="pi pi-file"></i>
                <span>Files & Documents</span>
              </span>
            </p-accordion-header>
            <p-accordion-content>
              <div class="accordion-content">
                <div class="files-section">
                  <div class="file-category" *ngIf="selectedOrder.logoFiles && selectedOrder.logoFiles.length > 0">
                    <div class="category-header">
                      <i class="pi pi-image"></i>
                      <h4>Logo Files</h4>
                      <span class="file-count">{{ selectedOrder.logoFiles.length }} files</span>
                    </div>
                    <div class="files-grid">
                      <div *ngFor="let file of selectedOrder.logoFiles" class="file-item">
                        <i class="pi pi-file-image file-icon"></i>
                        <span class="file-name">{{ file }}</span>
                        <div class="file-actions">
                          <button class="action-btn" title="Download">
                            <i class="pi pi-download"></i>
                          </button>
                          <button class="action-btn" title="Preview">
                            <i class="pi pi-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="file-category" *ngIf="selectedOrder.designFiles && selectedOrder.designFiles.length > 0">
                    <div class="category-header">
                      <i class="pi pi-file"></i>
                      <h4>Design Files</h4>
                      <span class="file-count">{{ selectedOrder.designFiles.length }} files</span>
                    </div>
                    <div class="files-grid">
                      <div *ngFor="let file of selectedOrder.designFiles" class="file-item">
                        <i class="pi pi-file file-icon"></i>
                        <span class="file-name">{{ file }}</span>
                        <div class="file-actions">
                          <button class="action-btn" title="Download">
                            <i class="pi pi-download"></i>
                          </button>
                          <button class="action-btn" title="Preview">
                            <i class="pi pi-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="file-category" *ngIf="selectedOrder.referenceImages && selectedOrder.referenceImages.length > 0">
                    <div class="category-header">
                      <i class="pi pi-images"></i>
                      <h4>Reference Images</h4>
                      <span class="file-count">{{ selectedOrder.referenceImages.length }} files</span>
                    </div>
                    <div class="files-grid">
                      <div *ngFor="let file of selectedOrder.referenceImages" class="file-item">
                        <i class="pi pi-image file-icon"></i>
                        <span class="file-name">{{ file }}</span>
                        <div class="file-actions">
                          <button class="action-btn" title="Download">
                            <i class="pi pi-download"></i>
                          </button>
                          <button class="action-btn" title="Preview">
                            <i class="pi pi-eye"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </p-accordion-content>
          </p-accordion-panel>

          <!-- Additional Information Panel -->
          <p-accordion-panel value="3" *ngIf="selectedOrder.specialInstructions || selectedOrder.packagingRequirements || selectedOrder.shippingAddress">
            <p-accordion-header>
              <span class="accordion-header-content">
                <i class="pi pi-info"></i>
                <span>Additional Information</span>
              </span>
            </p-accordion-header>
            <p-accordion-content>
              <div class="accordion-content">
                <div class="data-list">
                  <!-- Special Requirements -->
                  <div class="data-section" *ngIf="selectedOrder.specialInstructions || selectedOrder.packagingRequirements || selectedOrder.shippingAddress">
                    <h4 class="section-title">
                      <i class="pi pi-info-circle"></i>
                      Special Requirements
                    </h4>
                    <div class="data-items">
                      <div class="data-item full-width" *ngIf="selectedOrder.specialInstructions">
                        <span class="label">Special Instructions</span>
                        <div class="value text-content">{{ selectedOrder.specialInstructions }}</div>
                      </div>
                      <div class="data-item full-width" *ngIf="selectedOrder.packagingRequirements">
                        <span class="label">Packaging Requirements</span>
                        <div class="value text-content">{{ selectedOrder.packagingRequirements }}</div>
                      </div>
                      <div class="data-item full-width" *ngIf="selectedOrder.shippingAddress">
                        <span class="label">Shipping Address</span>
                        <div class="value text-content">{{ selectedOrder.shippingAddress }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Order Timeline -->
                  <div class="data-section">
                    <h4 class="section-title">
                      <i class="pi pi-clock"></i>
                      Order Timeline
                    </h4>
                    <div class="data-items">
                      <div class="data-item">
                        <span class="label">Order Created</span>
                        <span class="value">{{ formatDate(selectedOrder.createdAt!) }}</span>
                      </div>
                      <div class="data-item" *ngIf="selectedOrder.updatedAt">
                        <span class="label">Last Updated</span>
                        <span class="value">{{ formatDate(selectedOrder.updatedAt) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </p-accordion-content>
          </p-accordion-panel>
        </p-accordion>
      </div>
    </div>
    
    <ng-template pTemplate="footer">
      <p-button 
        label="Close" 
        icon="pi pi-times" 
        (onClick)="closeOrderDetails()"
        severity="secondary">
      </p-button>
      <p-button 
        label="Update Status" 
        icon="pi pi-refresh" 
        *ngIf="isAdminOrManager() && selectedOrder.status !== OrderStatus.DELIVERED && selectedOrder.status !== OrderStatus.CANCELLED"
        severity="primary">
      </p-button>
    </ng-template>
  </p-dialog>

  <!-- Toast Messages -->
  <p-toast></p-toast>
  
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>
</div>
